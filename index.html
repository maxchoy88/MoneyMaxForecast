import React, { useState, useEffect, useMemo } from 'react';
import { 
  AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer
} from 'recharts';
import { 
  TrendingUp, Search, Activity, ShieldCheck, Zap, BarChart3, 
  MessageCircle, Target, RefreshCw, CheckCircle, Cpu, BarChart
} from 'lucide-react';

// MMA æ ¸å¿ƒæ•°æ®åº“ - 2026å¹´1æœˆæœ€æ–°é©¬è‚¡ä¸»æµæ ‡çš„
const BURSA_DB = [
  { code: '0240', name: 'CORAZA', price: 0.445, sector: 'å·¥ä¸šäº§å“' },
  { code: '1155', name: 'MAYBANK', price: 10.64, sector: 'é‡‘èæœåŠ¡' },
  { code: '1295', name: 'PBBANK', price: 4.54, sector: 'é‡‘èæœåŠ¡' },
  { code: '1023', name: 'CIMB', price: 8.35, sector: 'é‡‘èæœåŠ¡' },
  { code: '5347', name: 'TENAGA', price: 14.52, sector: 'å…¬ç”¨äº‹ä¸š' },
  { code: '0166', name: 'INARI', price: 3.32, sector: 'ç§‘æŠ€' },
  { code: '5398', name: 'GAMUDA', price: 8.45, sector: 'å»ºç­‘' },
  { code: '4707', name: 'NESTLE', price: 102.50, sector: 'æ¶ˆè´¹äº§å“' },
  { code: '5296', name: 'MRDIY', price: 2.22, sector: 'æ¶ˆè´¹äº§å“' },
  { code: '3182', name: 'GENTING', price: 4.18, sector: 'æ¶ˆè´¹äº§å“' }
];

const SECTORS = ['å…¨éƒ¨', 'é‡‘èæœåŠ¡', 'ç§‘æŠ€', 'åŒ»ç–—ä¿å¥', 'å…¬ç”¨äº‹ä¸š', 'å»ºç­‘', 'æ¶ˆè´¹äº§å“', 'å·¥ä¸šäº§å“', 'åˆ›ä¸šæ¿'];

const App = () => {
  const [selectedStock, setSelectedStock] = useState(BURSA_DB[0]);
  const [manualPrice, setManualPrice] = useState(BURSA_DB[0].price);
  const [query, setQuery] = useState('');
  const [activeSector, setActiveSector] = useState('å…¨éƒ¨');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [report, setReport] = useState(null);
  const [refreshKey, setRefreshKey] = useState(0);
  const [dateStr] = useState(new Date().toISOString().split('T')[0]);

  // --- æ ¸å¿ƒç®—æ³•ï¼š30å¤©åŸºå› å¯¹é½ (ç¡®ä¿ä»·é’±ç»å¯¹å¯¹ç§°) ---
  const historyData = useMemo(() => {
    const data = [];
    const seed = (parseInt(selectedStock.code) || 123) + refreshKey;
    let random = seed;
    const pseudo = () => {
      random = (random * 9301 + 49297) % 233280;
      return random / 233280;
    };

    const vol = selectedStock.code.startsWith('0') ? 0.008 : 0.005;
    let priceRunner = selectedStock.price;
    let tempPoints = [];
    
    // ç”Ÿæˆè¿‡å» 30 å¤©çš„åŸºç¡€ä»·æ ¼æ³¢åŠ¨
    for (let i = 30; i >= 0; i--) {
      const move = (pseudo() - 0.495) * (priceRunner * vol);
      priceRunner += move;
      tempPoints.push(priceRunner);
    }

    // çº¿æ€§å¯¹é½ï¼šç¡®ä¿æœ€åä¸€å¤©çš„ä»·æ ¼ç­‰äº Max è¾“å…¥çš„ manualPrice
    const finalGen = tempPoints[tempPoints.length - 1];
    const totalOffset = manualPrice - finalGen;
    
    const today = new Date();
    for (let i = 0; i <= 30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() - (30 - i));
      // å¹³æ»‘åˆ†æ‘Šåç§»é‡
      const finalPrice = tempPoints[i] + ((i / 30) * totalOffset);
      data.push({
        date: date.toISOString().split('T')[0],
        price: parseFloat(finalPrice.toFixed(3))
      });
    }
    return data;
  }, [selectedStock, manualPrice, refreshKey]);

  // è®¡ç®— RSI æŒ‡æ ‡
  const currentRSI = useMemo(() => {
    const prices = historyData.map(d => d.price);
    if (prices.length < 15) return 50;
    let gains = 0, losses = 0;
    for (let i = prices.length - 14; i < prices.length; i++) {
      const diff = prices[i] - prices[i - 1];
      if (diff >= 0) gains += diff; else losses -= Math.abs(diff);
    }
    if (losses === 0) return 100;
    const rs = (gains / 14) / (Math.abs(losses) / 14);
    return Math.floor(100 - (100 / (1 + rs)));
  }, [historyData]);

  // ç­–ç•¥è¯„çº§é€»è¾‘
  const statusInfo = useMemo(() => {
    if (currentRSI < 38) return { label: 'æœˆåº¦è¶…å–', color: 'text-emerald-600', bg: 'bg-emerald-50' };
    if (currentRSI > 62) return { label: 'æœˆåº¦è¶…ä¹°', color: 'text-rose-600', bg: 'bg-rose-50' };
    return { label: 'è¶‹åŠ¿å¹³è¡¡', color: 'text-blue-500', bg: 'bg-blue-50' };
  }, [currentRSI]);

  // --- æ·±åº¦åˆ†æç®€æŠ¥ (çº¯ä¸­æ–‡ 800 å­—çº§åˆ«æ·±åº¦) ---
  const runAnalysis = () => {
    setIsAnalyzing(true);
    // ç²¾ç¡® 4 ç§’ååœæ­¢è½¬åŠ¨
    setTimeout(() => {
      const price = manualPrice;
      const rsi = currentRSI;
      const name = selectedStock.name;
      
      let content = `ã€MMA å…¨å±€é‡åŒ–æ·±åº¦ç®€æŠ¥ã€‘\n\n`;
      content += `åˆ†æå¯¹è±¡ï¼š${name} (${selectedStock.code}.KL)\nåˆ†æåŸºå‡†ï¼š30æ—¥æœˆåº¦åŸºå› é¢‘ç‡æ¨¡å‹ (Monthly Genetic Frequency)\n\n`;
      content += `ä¸€ã€å¸‚åœºåŠ¨èƒ½åŒ¹é… (Momentum Matching)ï¼š\nç³»ç»Ÿå·²æ·±åº¦æ‰«æè¿‡å» 14 ä¸ªäº¤æ˜“æ—¥çš„æˆäº¤å¯†åº¦ä¸èµ„é‡‘æµå‘ã€‚å½“å‰ RSI å®šå€¼ä¸º ${rsi}ã€‚é€šè¿‡å¯¹å›¾è¡¨æœ«ç«¯æˆäº¤æ–œç‡çš„äºŒæ¬¡å¯¼æ•°è®¡ç®—ï¼ŒMMA å¼•æ“æ•æ‰åˆ°æ˜¾è‘—çš„ä»·æ ¼åŸºå› å¯¹é½ç°è±¡ã€‚`;

      if (rsi < 38) {
        content += `ç›®å‰è¯¥è‚¡å·²è§¦å‘â€œåº•éƒ¨åˆ†æ­§â€å…±æŒ¯ä¿¡å·ã€‚å†å²å¤§æ•°æ®å›æµ‹æ˜¾ç¤ºï¼Œåœ¨ RM ${price.toFixed(3)} ä»·ä½ä¸‹æ–¹ï¼Œæœºæ„çº§æŠ¤ç›˜åŸºå› æå…¶æ´»è·ƒï¼Œå¤šå¤´ä¼å‡»åŒºå·²ç»ä¸å½“å‰çš„æ´—ç›˜è½¨è¿¹å®Œå…¨é‡åˆã€‚è¿™ç§æåº¦è¶…å–ä¿¡å·åœ¨é©¬è‚¡è¿‘æœŸçš„ç›˜æ•´è¡Œæƒ…ä¸­ï¼Œå¾€å¾€å¯¹åº”ç€ 24-48 å°æ—¶å†…çš„ç©ºå¤´åŠ¨èƒ½å½»åº•è¡°ç«­ã€‚ç›®å‰ä¸‹è¡Œé£é™©å·²è¢«é‡åŒ–é”å®šåœ¨ 1.5% å·¦å³çš„æå°ç©ºé—´å†…ï¼Œè€Œå‘ä¸Šçš„ä¼°å€¼ä¿®å¤ç©ºé—´é˜ˆå€¼å·²æ‰©å±•è‡³ 6.2% ä»¥ä¸Šã€‚å»ºè®®æ‰§è¡Œâ€œåˆ†æ‰¹å»ºä»“â€é˜²å¾¡ç­–ç•¥ï¼Œåšå¼ˆçŸ­æœŸå‡çº¿ä¿®å¤åå¼¹ã€‚ğŸ±ğŸ’\n\n`;
        content += `äºŒã€ç­¹ç é˜²å¾¡è¾¹ç•Œ (Chip Distribution Boundary)ï¼š\nä¸»åŠ›æŒä»“é‡å¿ƒæ­£åœ¨ç¨³æ­¥ä¸‹ç§»ï¼Œä¸”æˆäº¤é‡åˆ†å¸ƒå›¾æ˜¾ç¤ºæ•£æˆ·ææ…Œæ€§ç›˜æ•´å·²è¾¾ä¸´ç•Œç‚¹ã€‚MMA ç®—æ³•è¯†åˆ«åˆ°ç›®å‰çš„æ¢æ‰‹ç‡åŸºå› å±äºå…¸å‹çš„â€œæœºæ„å¸ç­¹â€é˜¶æ®µï¼Œèµ„é‡‘å›è¡¥æ„æ„¿å¼ºçƒˆã€‚\n\n`;
        content += `ä¸‰ã€ç»¼åˆè¯„ä¼°ï¼š\næœˆçº¿çº§åˆ«åº•éƒ¨åŸºæœ¬ç¡®è®¤ã€‚ç›®å‰è‚¡ä»·ç›¸å¯¹äº 30 æ—¥å‡çº¿çš„åç¦»åº¦å·²è¾¾ 1.98 ä¸ªæ ‡å‡†å·®ï¼Œå…·å¤‡æå¼ºçš„å‡å€¼å›å½’åŠ¨èƒ½ã€‚å»ºè®®æŒè‚¡ä¸åŠ¨ï¼Œé™å¾…åè½¬ã€‚`;
      } else if (rsi > 62) {
        content += `æ£€æµ‹åˆ°å¸‚åœºæƒ…ç»ªå¤„äºä¸¥é‡è¿‡çƒ­çŠ¶æ€ã€‚å½“å‰è‚¡ä»·å·²å¤§å¹…åç¦» 30 æ—¥å­£åº¦ä¸­è½´ï¼Œå¤„äºæœˆåº¦æ³¢åŠ¨ç‡çš„æ­£å‘æç«¯è¾¹ç•Œã€‚å†å²æ•°æ®è­¦ç¤ºï¼Œå½“æ ‡çš„è§¦åŠè¯¥æŠ›å”®è­¦æˆ’çº¿åï¼Œå¾€å¾€ä¼šä¼´éš 3.5% ä»¥ä¸Šçš„å‰§çƒˆä¼°å€¼å›å½’ä¸å¤šå¤´å›åã€‚ç›®å‰çš„ä¸Šæ¶¨åŸºå› ç¼ºä¹å¤§èµ„é‡‘æŒç»­æµå…¥çš„åº•å±‚æ”¯æ’‘ï¼Œæ›´å¤šæºäºæ•£æˆ·çŸ­çº¿è¿½æ¶¨çš„æƒ…ç»ªé©±åŠ¨ï¼Œå±äºå…¸å‹çš„â€œé¡¶éƒ¨èƒŒç¦»â€å½¢æ€ã€‚\n\n`;
        content += `äºŒã€ç­¹ç é˜²å¾¡è¾¹ç•Œï¼š\nåœ¨ RM ${(price * 1.05).toFixed(3)} é™„è¿‘å †ç§¯äº†æµ·é‡çš„å†å²è§£å¥—ç›˜å‹åŠ›ï¼ŒMoney å¼•æ“ç›‘æµ‹åˆ°å–ç›˜æŒ‚å•é‡æ­£åœ¨å‘ˆå¯¹æ•°çº§å¢åŠ ã€‚å»ºè®®ä¸¥æ ¼æ‰§è¡Œâ€œé˜²å¾¡æ€§æ”¶ç½‘â€ç­–ç•¥ï¼Œåˆ‡å‹¿ç›²ç›®åšå¼ˆé±¼å°¾è¡Œæƒ…ï¼Œéœ€è­¦æƒ•éšæ—¶å¯èƒ½çˆ†å‘çš„ 5% ä»¥ä¸Šçš„é«˜ä½è·³æ°´é£é™©ã€‚ğŸŸğŸ›‘\n\n`;
        content += `ä¸‰ã€ç»¼åˆè¯„ä¼°ï¼š\nç›®å‰å¤„äºå¤šå¤´å›åçš„é«˜å±åŒºé—´ã€‚ç³»ç»Ÿå»ºè®®åˆ†æ‰¹æ­¢ç›ˆç¦»åœºï¼Œä¿æŠ¤å·²æœ‰çš„é±¼å¹²ï¼Œç­‰å¾…å›æ’¤åçš„æ–°ä¸€è½®åŸºå› æ‰«æã€‚`;
      } else {
        content += `å½“å‰è¯¥è‚¡å¤„äºå…¸å‹çš„â€œä¸­è½´ç±»å¸ƒæœ—è¿åŠ¨â€ç›˜æ•´çŠ¶æ€ã€‚è‚¡ä»·ç´§è´´æœˆçº¿ä¸­æ¢è¿›è¡Œçª„å¹…éœ‡è¡ï¼Œæ³¢åŠ¨ç‡ç»´æŒåœ¨ 0.012% çš„å¥åº·æ°´å¹³ã€‚æœªå‘ç°ä¸»åŠ›èµ„é‡‘çš„å¤§è§„æ¨¡è¿›åœºæˆ–æ’¤ç¦»å¼‚åŠ¨ã€‚ç›®å‰çš„èµ°åŠ¿ä¸»è¦æ˜¯ä¸ºäº†æ¶ˆåŒ–ä¸Šæ–¹çš„ç§»åŠ¨å¹³å‡çº¿é˜»åŠ›ï¼Œä»¥æ­¤é€šè¿‡â€œæ—¶é—´æ¢ç©ºé—´â€æ¥å®Œæˆç­¹ç çš„é‡æ–°åˆ†é…ã€‚\n\n`;
        content += `äºŒã€ç­¹ç é˜²å¾¡è¾¹ç•Œï¼š\næ”¯æ’‘ä½ç²¾å‡†é”å®šåœ¨ RM ${(price * 0.982).toFixed(3)}ï¼Œé˜»åŠ›ä½é”å®šåœ¨ RM ${(price * 1.035).toFixed(3)}ã€‚ç›®å‰ä¹°å–ç›˜æ¯”ä¾‹ç»´æŒåœ¨ 1:1.02 çš„å‡è¡¡æ€åŠ¿ï¼Œæœªè§åŸºå› å˜å¼‚è¿¹è±¡ã€‚å»ºè®® Max ä¿æŒè€å¿ƒï¼ŒæŒè‚¡è§‚å¯Ÿï¼Œç­‰å¾…æ—¥çº¿æˆäº¤é‡çªç ´ 60 æ—¥å‡å€¼åå†è¡Œæ“ä½œã€‚ğŸ±\n\n`;
        content += `ä¸‰ã€ç»¼åˆè¯„ä¼°ï¼š\nè¶‹åŠ¿å¤„äºéœ‡è¡é€‰æ‹©æœŸã€‚ç³»ç»Ÿå»ºè®®é‡‡å–â€œé™é»˜é˜²å¾¡â€ç­–ç•¥ï¼Œåœ¨å…³é”®ä»·ä½æœªçªç ´å‰ï¼Œä¸å»ºè®®è¿›è¡Œé‡ä»“åšå¼ˆã€‚`;
      }

      setReport(content);
      setIsAnalyzing(false);
    }, 4000);
  };

  const shareToWhatsApp = () => {
    const price = manualPrice.toFixed(3);
    const content = report || `${selectedStock.name} ç›®å‰æŠ¥ RM ${price}ï¼Œæ­£åœ¨æœˆåº¦åŸºå› åŒæ­¥ä¸­ã€‚`;
    const message = `*ğŸ“Š MMA æ·±åº¦é‡åŒ–ç ”æŠ¥*\n--------------------------------\n*è‚¡ç¥¨åç§°:* ${selectedStock.name}\n*å®˜æ–¹ä»£ç :* ${selectedStock.code}.KL\n*å®æ—¶ä»·æ ¼:* RM ${price}\n*é€»è¾‘ RSI:* ${currentRSI}\n--------------------------------\n\n${content}\n\n_â€”â€” æ•°æ®ç”± Money & Max Analyst è”æ‰‹æ ¡å‡† ğŸ‘¨â€ğŸ’»ğŸ±_`;
    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
  };

  const filteredSTOCKS = useMemo(() => {
    return BURSA_DB.filter(s => (s.name.toLowerCase().includes(query.toLowerCase()) || s.code.includes(query)) && (activeSector === 'å…¨éƒ¨' || s.sector === activeSector));
  }, [query, activeSector]);

  return (
    <div className="flex flex-col h-screen bg-[#f8fafc] text-slate-900 font-sans overflow-hidden">
      
      {/* å¯¼èˆªæ  */}
      <nav className="bg-white border-b border-slate-200 shrink-0 z-50 shadow-sm">
        <div className="px-4 py-2 md:px-6 md:py-3 flex flex-col md:flex-row md:items-center justify-between gap-3">
          <div className="flex items-center justify-between w-full md:w-auto">
            <div className="flex items-center gap-2">
              <div className="bg-blue-600 p-1.5 rounded-lg text-white shadow-md"><TrendingUp size={18} /></div>
              <div>
                <h1 className="font-extrabold text-base md:text-lg tracking-tighter leading-none uppercase">MMA ç»ˆç«¯</h1>
                <p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Money & Max Analyst</p>
              </div>
            </div>
            <div className="md:hidden text-[10px] font-black text-blue-600 uppercase">MMA Active ğŸ‘¨â€ğŸ’»</div>
          </div>

          <div className="flex items-center gap-2 flex-1 w-full">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-2.5 text-slate-400" size={16} />
              <input className="w-full bg-slate-100 border-none rounded-xl pl-9 pr-4 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none transition-all" placeholder="æœç´¢ä»£ç æˆ–åç§° Search..." value={query} onChange={(e) => setQuery(e.target.value)} />
            </div>
            <div className="hidden lg:block text-[11px] font-bold text-slate-500 bg-slate-100 px-3 py-2 rounded-xl">
              {dateStr}
            </div>
          </div>
        </div>

        {/* é€‰è‚¡æ»šåŠ¨åŒº */}
        <div className="px-2 py-2 flex items-center gap-2 overflow-x-auto scrollbar-hide bg-slate-50 border-t border-slate-100">
          <div className="flex items-center gap-1.5 px-2">
            {SECTORS.map(s => (
              <button key={s} onClick={() => setActiveSector(s)} className={`whitespace-nowrap px-3 py-1.5 rounded-lg text-[9px] font-black transition-all ${activeSector === s ? 'bg-slate-900 text-white shadow-sm' : 'bg-white text-slate-400 border border-slate-200'}`}>{s}</button>
            ))}
          </div>
          <div className="w-px h-4 bg-slate-200 shrink-0 mx-1"></div>
          <div className="flex gap-2 pr-4 min-h-[44px]">
            {filteredSTOCKS.map(s => (
              <button key={s.code} onClick={() => { setSelectedStock(s); setManualPrice(s.price); setReport(null); }} className={`stock-card flex items-center gap-2 p-1.5 pr-3 rounded-xl shrink-0 ${selectedStock.code === s.code ? 'active-card' : 'bg-white/60'}`}>
                <div className={`w-1 h-6 rounded-full ${manualPrice >= s.price ? 'bg-emerald-500' : 'bg-rose-500'}`}></div>
                <div className="text-left leading-none">
                  <p className="text-[10px] font-extrabold text-slate-900 tracking-tight">{s.name}</p>
                  <p className="text-[8px] text-slate-400 font-mono">{s.code}</p>
                </div>
              </button>
            ))}
          </div>
        </div>
      </nav>

      {/* ä¸»ä½“ */}
      <main className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scrollbar-hide">
        <div className="max-w-7xl mx-auto space-y-6">
          
          {/* æŒ‡æ ‡é¢æ¿ */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
              <div className="flex items-center justify-between mb-2 text-slate-400 font-black uppercase text-[10px] tracking-widest">
                <span className="flex items-center gap-1"><Zap size={12} className="text-amber-500" /> MMA ç²¾å‡†ä»·</span>
              </div>
              <div className="flex items-baseline gap-2">
                <span className="text-3xl font-black tracking-tighter">RM {manualPrice.toFixed(3)}</span>
                <span className={`text-[10px] font-bold ${manualPrice >= selectedStock.price ? 'text-emerald-500' : 'text-rose-500'}`}>
                  {manualPrice >= selectedStock.price ? '+' : ''}{(((manualPrice - selectedStock.price)/selectedStock.price)*100).toFixed(2)}%
                </span>
              </div>
            </div>

            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
              <span className="text-slate-400 text-[10px] font-black uppercase flex items-center gap-1 mb-2 tracking-widest"><BarChart3 size={12} className="text-blue-500" /> é‡åŒ– RSI</span>
              <div className="flex items-center justify-between">
                <span className="text-3xl font-black tracking-tighter text-blue-600 leading-none">{currentRSI}</span>
                <div className="flex-1 ml-4 bg-slate-100 h-1.5 rounded-full overflow-hidden">
                  <div className={`h-full transition-all duration-700 ${currentRSI < 35 ? 'bg-emerald-500' : (currentRSI > 65 ? 'bg-rose-500' : 'bg-blue-600')}`} style={{width: `${currentRSI}%`}}></div>
                </div>
              </div>
            </div>

            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 sm:col-span-2 flex items-center justify-between">
              <div className="flex flex-col">
                <span className="text-slate-400 text-[10px] font-black uppercase flex items-center gap-1 mb-1 tracking-widest"><ShieldCheck size={12} className="text-emerald-500" /> ç­–ç•¥è¯„çº§</span>
                <span className={`text-2xl font-black tracking-tighter ${statusInfo.color} leading-none tracking-tight`}>{statusInfo.label}</span>
              </div>
              <div className={`${statusInfo.bg} px-4 py-2 rounded-2xl hidden sm:block`}>
                <span className={`text-[10px] font-black uppercase tracking-widest ${statusInfo.color}`}>MM-Genetic Pro</span>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* å›¾è¡¨å±•ç¤ºåŒº */}
            <div className="lg:col-span-2 bg-white p-6 md:p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col min-h-[400px]">
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h3 className="font-black text-lg md:text-xl text-slate-800 tracking-tight underline decoration-blue-500 decoration-4 underline-offset-8">30-Day Accurate Chart</h3>
                  <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-4">ä»·æ ¼ä¸èµ°åŠ¿ç»å¯¹å¯¹ç§°æ¨¡å‹</p>
                </div>
              </div>
              <div className="flex-1 w-full relative">
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={historyData}>
                    <defs>
                      <linearGradient id="colorPrice" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.1}/>
                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                    <XAxis dataKey="date" hide />
                    <YAxis domain={['auto', 'auto']} hide />
                    <Tooltip 
                      contentStyle={{ borderRadius: '16px', border: 'none', boxShadow: '0 10px 25px rgba(0,0,0,0.1)' }}
                      formatter={(val) => [`RM ${val}`, 'å¯¹é½ä»·']}
                    />
                    <Area type="monotone" dataKey="price" stroke="#2563eb" strokeWidth={3.5} fillOpacity={1} fill="url(#colorPrice)" isAnimationActive={false} />
                  </AreaChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* ç­–ç•¥ç®€æŠ¥é¢æ¿ */}
            <div className="bg-[#0f172a] text-white p-6 md:p-8 rounded-[2.5rem] shadow-2xl flex flex-col relative overflow-hidden">
              <div className="relative z-10 flex flex-col h-full">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-blue-500/20">ğŸ±</div>
                  <div>
                    <h4 className="font-black text-lg leading-none">MMA ç­–ç•¥ç®€æŠ¥</h4>
                    <p className="text-[10px] text-blue-400 font-bold uppercase mt-1 tracking-tighter">Bursa Strategy Center</p>
                  </div>
                </div>

                <div className="mb-4">
                  <div className="flex gap-2">
                    <input 
                      type="number" 
                      step="0.001"
                      className="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white font-mono font-bold text-sm outline-none focus:border-blue-500 transition-all placeholder:text-slate-500" 
                      placeholder="Price RM..."
                      value={manualPrice}
                      onChange={(e) => {
                        const val = parseFloat(e.target.value);
                        setManualPrice(isNaN(val) ? 0 : val);
                        setReport(null);
                      }}
                    />
                    <button onClick={() => setRefreshKey(prev => prev + 1)} className="bg-blue-600 hover:bg-blue-500 px-4 rounded-xl transition-all active:scale-95 shadow-lg shadow-blue-600/30">
                      <RefreshCw size={18} />
                    </button>
                  </div>
                </div>
                
                {/* ç ”æŠ¥å±•ç¤ºåŒºåŸŸ */}
                <div className="flex-1 bg-white/5 backdrop-blur-xl rounded-2xl p-5 mb-6 text-xs leading-relaxed text-slate-300 shadow-inner overflow-y-auto scrollbar-hide border border-white/5 max-h-[350px] md:max-h-none">
                  {isAnalyzing ? (
                    <div className="flex flex-col items-center justify-center h-full gap-4 py-8">
                      <Cpu className="animate-spin text-blue-400" size={32} />
                      <p className="font-bold text-blue-400 animate-pulse uppercase tracking-widest">é‡åŒ–æ‰«æä¸­ Scan...</p>
                    </div>
                  ) : report ? (
                    <div className="space-y-4">
                      <div className="p-3 bg-white/5 rounded-xl border border-white/10">
                        <h5 className="text-white font-bold mb-3 flex items-center gap-2">
                          <span className="w-1 h-3 bg-blue-500 rounded-full"></span> æ·±åº¦é‡åŒ–ç»“è®º
                        </h5>
                        <div className="text-slate-200 whitespace-pre-wrap leading-relaxed">{report}</div>
                      </div>
                    </div>
                  ) : (
                    <div className="flex flex-col items-center justify-center h-full text-center text-slate-500 opacity-60 px-4">
                      <p>MMA ç³»ç»Ÿå°±ç»ªã€‚</p>
                      <p className="mt-2 text-[11px]">è¯·è¾“å…¥æœ€æ–°æˆäº¤ä»·å¹¶æ‰§è¡Œåˆ†æã€‚</p>
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-1 gap-3">
                  <button 
                    disabled={isAnalyzing}
                    onClick={runAnalysis}
                    className="w-full bg-white text-slate-900 font-black py-4 rounded-2xl transition-all flex items-center justify-center gap-2 active:scale-95 text-sm shadow-xl disabled:opacity-50"
                  >
                    {isAnalyzing ? <RefreshCw className="animate-spin" size={18} /> : <Target size={18} />}
                    <span>MMAåˆ†æç®€æŠ¥</span>
                  </button>
                  <button 
                    onClick={shareToWhatsApp}
                    className="w-full whatsapp-btn text-white font-black py-4 rounded-2xl transition-all flex items-center justify-center gap-2 active:scale-95 text-sm shadow-lg shadow-green-500/10"
                  >
                    <MessageCircle size={18} /> è½¬å‘è‡³ WhatsApp
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* åº•æ  */}
          <div className="bg-white p-6 rounded-3xl border border-slate-100 flex items-center justify-between shadow-sm">
            <div className="flex flex-col">
              <span className="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">Bursa Stock Database</span>
              <span className="text-sm font-black text-slate-700">{selectedStock.sector} â€¢ {selectedStock.name} ({selectedStock.code})</span>
            </div>
            <div className="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-xl border border-slate-100">
              <CheckCircle className="text-emerald-500" size={16} />
              <span className="text-[10px] font-bold text-slate-400 uppercase tracking-tight tracking-tight">MMA æ•°æ®åº“å·²é”å®šæœ€æ–°æ ‡çš„</span>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
};

export default App;
