<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MMA ç»ˆç«¯ - çº¯ä¸­æ–‡é«˜æ¸…åŠ å›ºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', "Microsoft YaHei", sans-serif; -webkit-font-smoothing: antialiased; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .stock-card { transition: all 0.2s; border: 1px solid #f1f5f9; cursor: pointer; }
        .active-card { border-color: #2563eb !important; background-color: white !important; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
        .loading-spin { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .whatsapp-btn { background-color: #25D366; transition: all 0.3s; }
        .whatsapp-btn:hover { background-color: #128C7E; transform: scale(1.02); }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 h-screen flex flex-col overflow-hidden text-sm">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white border-b border-slate-200 shrink-0 z-50">
        <div class="px-4 py-2 md:px-6 md:py-3 flex flex-col md:flex-row md:items-center justify-between gap-2 md:gap-6">
            <div class="flex items-center justify-between w-full md:w-auto">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 p-1.5 rounded-lg text-white shadow-md">
                        <i data-lucide="trending-up" size="18"></i>
                    </div>
                    <div>
                        <h1 class="font-extrabold text-base md:text-lg tracking-tighter leading-none uppercase text-slate-800">MMA ç»ˆç«¯</h1>
                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Money & Max Analyst</p>
                    </div>
                </div>
                <div class="text-right md:hidden text-[10px] font-black text-blue-600 uppercase">MMA Live HD</div>
            </div>

            <div class="flex items-center gap-2 flex-1 w-full">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
                    <input id="searchInput" type="text" 
                        class="w-full bg-slate-100 border-none rounded-xl pl-9 pr-4 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none transition-all"
                        placeholder="è¾“å…¥æœç´¢ (0240, MAYBANK)...">
                </div>
                <div id="headerDate" class="hidden lg:block text-[11px] font-bold text-slate-500 bg-slate-100 px-3 py-2 rounded-xl">--</div>
            </div>
        </div>

        <div class="px-2 py-2 flex items-center gap-2 overflow-x-auto scrollbar-hide bg-slate-50 border-t border-slate-100">
            <div id="sectorFilters" class="flex items-center gap-1.5 px-2"></div>
            <div class="w-px h-4 bg-slate-200 shrink-0 mx-1"></div>
            <div id="stockList" class="flex gap-2 pr-4 min-h-[44px]"></div>
        </div>
    </nav>

    <!-- éšè— ID å ä½ -->
    <span id="stockCountLabel" class="hidden"></span>

    <!-- ä¸»ä½“åŒºåŸŸ -->
    <main class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 md:space-y-6 scrollbar-hide">
        <div class="max-w-7xl mx-auto space-y-4 md:space-y-6">
            
            <!-- æ•°æ®é¢æ¿ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest flex items-center gap-1">
                            <i data-lucide="zap" class="text-amber-500 w-3 h-3"></i> MMA ç°ä»·
                        </span>
                        <span id="priceAsOfDate" class="text-[9px] font-bold text-slate-400">--</span>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="displayPrice" class="text-3xl font-black tracking-tighter leading-none">RM 0.000</span>
                        <span id="displayChange" class="text-[10px] font-bold">--</span>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                    <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest flex items-center gap-1 mb-2">
                        <i data-lucide="bar-chart-3" class="text-blue-500 w-3 h-3"></i> é‡åŒ– RSI
                    </span>
                    <div class="flex items-center justify-between">
                        <span id="displayRSI" class="text-3xl font-black tracking-tighter text-blue-600 leading-none">--</span>
                        <div class="flex-1 ml-4 bg-slate-100 h-1.5 rounded-full overflow-hidden">
                            <div id="rsiBar" class="h-full bg-blue-500 transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 sm:col-span-2 flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest flex items-center gap-1 mb-1">
                            <i data-lucide="shield-check" class="text-emerald-500 w-3 h-3"></i> 30D ç­–ç•¥è¯„çº§
                        </span>
                        <span id="displayStatus" class="text-2xl font-black tracking-tighter text-slate-400 leading-none">åˆ†æä¸­...</span>
                    </div>
                    <div class="bg-blue-50 px-4 py-2 rounded-2xl">
                        <span id="signalStrength" class="text-[10px] font-black text-blue-600 uppercase tracking-widest">MMA Pro</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- è¶‹åŠ¿å›¾ -->
                <div class="lg:col-span-2 bg-white p-6 md:p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col min-h-[350px]">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 id="chartTitle" class="font-black text-lg md:text-xl text-slate-800 tracking-tight underline decoration-blue-500 decoration-4 underline-offset-8">30å¤©ç²¾å‡†é‡åŒ–</h3>
                            <p id="chartSub" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-4">ä»·æ ¼ä¸èµ°åŠ¿ç»å¯¹å¯¹ç§°æ¨¡å‹</p>
                        </div>
                    </div>
                    <div class="flex-1 w-full relative">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- ç­–ç•¥ä¸­å¿ƒ -->
                <div class="bg-[#0f172a] text-white p-6 md:p-8 rounded-[2.5rem] shadow-2xl flex flex-col relative overflow-hidden">
                    <div class="relative z-10 flex flex-col h-full">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg">ğŸ±</div>
                            <div>
                                <h4 class="font-black text-lg leading-none uppercase">MMA ç­–ç•¥ç®€æŠ¥</h4>
                                <p class="text-[10px] text-blue-400 font-bold uppercase mt-1 tracking-tighter">Independent Analysis Hub</p>
                            </div>
                        </div>

                        <!-- ä»·æ ¼æ ¡å‡† -->
                        <div class="mb-4">
                            <div class="flex gap-2">
                                <input type="number" id="manualPriceInput" step="0.001" 
                                    class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white font-mono font-bold text-sm outline-none focus:border-blue-500 transition-all placeholder:text-slate-500" 
                                    placeholder="è¾“å…¥æˆäº¤ä»· RM...">
                                <button onclick="calibratePrice()" class="bg-blue-600 hover:bg-blue-500 px-4 rounded-xl transition-all active:scale-95 shadow-lg">
                                    <i data-lucide="refresh-cw" size="18"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 800å­—ç®€æŠ¥åŒºåŸŸ -->
                        <div id="moneyAdvice" class="flex-1 bg-white/5 backdrop-blur-xl rounded-2xl p-5 mb-6 text-xs leading-relaxed text-slate-300 shadow-inner overflow-y-auto scrollbar-hide border border-white/5 max-h-[260px] md:max-h-none">
                            â€œMMA ç³»ç»Ÿå·²åŠ å›ºå®Œæˆã€‚è¯·è¾“å…¥æœ€æ–°ä»·ä½å¹¶ç‚¹å‡»ä¸‹æ–¹æ‰§è¡Œåˆ†æï¼Œè·å– 800 å­—æ·±åº¦é‡åŒ–ç»“è®ºã€‚â€
                        </div>

                        <!-- æŒ‰é’®ç»„ -->
                        <div class="grid grid-cols-1 gap-3">
                            <button id="deepAnalysisBtn" onclick="runDeepAnalysis()" class="w-full bg-white text-slate-900 font-black py-4 rounded-2xl transition-all flex items-center justify-center gap-2 active:scale-95 text-sm shadow-xl">
                                <span id="btnIconWrapper"><i data-lucide="target" size="18"></i></span>
                                <span id="btnText">MMAåˆ†æç®€æŠ¥</span>
                            </button>
                            <button id="whatsappShareBtn" onclick="shareToWhatsApp()" class="w-full whatsapp-btn text-white font-black py-4 rounded-2xl transition-all flex items-center justify-center gap-2 active:scale-95 text-sm">
                                <i data-lucide="message-circle" size="18"></i> è½¬å‘è‡³ WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åº•æ  -->
            <div class="bg-white p-6 rounded-3xl border border-slate-100 flex items-center justify-between shadow-sm">
                <div class="flex flex-col">
                    <span class="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">Bursa Stock Database</span>
                    <span id="displaySector" class="text-sm font-black text-slate-700">--</span>
                </div>
                <div class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-xl border border-slate-100">
                    <i data-lucide="shield-check" class="text-emerald-500 w-4 h-4"></i>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">UTF-8 é«˜æ¸…ç¼–ç é”å®š</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // MMA æ•°æ®åº“ - 2026æœ€æ–°æ•°æ®
        const BURSA_DB = [
            { code: '0240', name: 'CORAZA', price: 0.445, sector: 'å·¥ä¸šäº§å“' },
            { code: '1155', name: 'MAYBANK', price: 10.64, sector: 'é‡‘èæœåŠ¡' },
            { code: '1295', name: 'PBBANK', price: 4.54, sector: 'é‡‘èæœåŠ¡' },
            { code: '1023', name: 'CIMB', price: 8.35, sector: 'é‡‘èæœåŠ¡' },
            { code: '5347', name: 'TENAGA', price: 14.52, sector: 'å…¬ç”¨äº‹ä¸š' },
            { code: '0166', name: 'INARI', price: 3.32, sector: 'ç§‘æŠ€' },
            { code: '5398', name: 'GAMUDA', price: 8.45, sector: 'å»ºç­‘' },
            { code: '4707', name: 'NESTLE', price: 102.50, sector: 'æ¶ˆè´¹äº§å“' },
            { code: '5296', name: 'MRDIY', price: 2.22, sector: 'æ¶ˆè´¹äº§å“' },
            { code: '3182', name: 'GENTING', price: 4.18, sector: 'æ¶ˆè´¹äº§å“' }
        ];

        const SECTORS_LIST = ['å…¨éƒ¨', 'é‡‘èæœåŠ¡', 'ç§‘æŠ€', 'åŒ»ç–—ä¿å¥', 'å…¬ç”¨äº‹ä¸š', 'å»ºç­‘', 'æ¶ˆè´¹äº§å“', 'åˆ›ä¸šæ¿'];
        const STOCKS = [...BURSA_DB.map((s, i) => ({...s, id: `core-${i}`, initialPrice: s.price}))];
        for (let i = STOCKS.length; i < 3500; i++) {
            const sec = SECTORS_LIST[i % SECTORS_LIST.length];
            const baseCode = sec === 'åˆ›ä¸šæ¿' ? `0${(300 + i).toString().padStart(3, '0')}` : `${(4000 + i).toString()}`;
            const p = parseFloat((Math.random() * 5 + 0.1).toFixed(3));
            STOCKS.push({ id: i.toString(), code: baseCode, name: `æ——èˆ°-${i}`, price: p, initialPrice: p, sector: sec });
        }

        let currentStock = STOCKS[0];
        let activeSector = 'å…¨éƒ¨';
        let mainChart = null;
        let historyDataset = [];
        let lastReport = ""; 

        function setText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                let diff = prices[i] - prices[i - 1];
                if (diff >= 0) gains += diff; else losses -= Math.abs(diff);
            }
            if (losses === 0) return 100;
            let rs = gains / losses;
            return Math.floor(100 - (100 / (1 + rs)));
        }

        function generateSmooth30DayHistory(stock, targetPrice) {
            const data = [];
            const seed = parseInt(stock.code) || 123;
            let random = seed;
            function pseudo() { random = (random * 9301 + 49297) % 233280; return random / 233280; }
            const vol = stock.code.startsWith('0') ? 0.008 : 0.005;
            let priceRunner = stock.initialPrice;
            let tempPoints = [];
            for (let i = 30; i >= 0; i--) {
                const move = (pseudo() - 0.495) * (priceRunner * vol);
                priceRunner += move;
                tempPoints.push(priceRunner);
            }
            const totalOffset = targetPrice - tempPoints[tempPoints.length - 1];
            const today = new Date();
            for (let i = 0; i <= 30; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - (30 - i));
                const finalPrice = tempPoints[i] + ((i / 30) * totalOffset);
                data.push({ date: d.toISOString().split('T')[0], price: parseFloat(Math.max(0.001, finalPrice).toFixed(3)) });
            }
            return data;
        }

        // --- MMA 800å­—æ·±åº¦åˆ†æç»“è®º ---
        window.runDeepAnalysis = () => {
            const btn = document.getElementById('deepAnalysisBtn');
            const iconWrapper = document.getElementById('btnIconWrapper');
            const btnText = document.getElementById('btnText');
            const adviceBox = document.getElementById('moneyAdvice');

            if(!btn || !adviceBox || !iconWrapper) return;

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            iconWrapper.innerHTML = '<i data-lucide="loader-2" class="loading-spin" size="18"></i>';
            btnText.innerText = "é‡åŒ–åŸºå› æ‰«æä¸­...";
            lucide.createIcons();

            setTimeout(() => {
                try {
                    const rsi = calculateRSI(historyDataset.map(d => d.price));
                    const price = currentStock.price;
                    const sector = currentStock.sector;
                    
                    let content = `ã€MMA å…¨å±€é‡åŒ–æ·±åº¦ç®€æŠ¥ã€‘\n\n`;
                    content += `åˆ†æå¯¹è±¡ï¼š${currentStock.name} (${currentStock.code}.KL)\nåˆ†æåŸºå‡†ï¼š30æ—¥æœˆåº¦åŸºå› é¢‘ç‡æ¨¡å‹ (Monthly Genetic Frequency)\n\n`;
                    content += `ä¸€ã€å¸‚åœºåŠ¨èƒ½ä¸æˆäº¤åŸºå› ï¼š\nMMA ç»ˆç«¯é€šè¿‡å¯¹è¿‡å» 14 ä¸ªäº¤æ˜“æ—¥çš„æˆäº¤å¯†åº¦è¿›è¡Œå¤šç»´æ‰«æã€‚å½“å‰ RSI å®šå€¼ä¸º ${rsi}ã€‚ç³»ç»Ÿåœ¨å›¾è¡¨æœ«ç«¯æ•æ‰åˆ°æ˜¾è‘—çš„â€œä»·æ ¼åŸºå› å¯¹é½â€ç°è±¡ã€‚å·¥ä¸šæ ‡çš„æ˜¾ç¤ºå‡ºæå¼ºçš„ç­¹ç ç¨³å®šæ€§ã€‚`;

                    if (rsi < 38) {
                        content += `ç›®å‰å·²è§¦å‘é«˜èƒœç‡çš„â€œåº•éƒ¨åˆ†æ­§â€å…±æŒ¯ä¿¡å·ã€‚å†å²åŸºå› åº“å›æµ‹æ˜¾ç¤ºï¼Œåœ¨ RM ${price.toFixed(3)} ä»·ä½ä¸‹æ–¹ï¼Œæœºæ„çº§æŠ¤ç›˜æ„æ„¿æå…¶å¼ºçƒˆï¼Œå¤šå¤´ä¼å‡»åŒºå·²ç»ä¸å½“å‰çš„æ´—ç›˜è½¨è¿¹å®Œå…¨é‡åˆã€‚è¿™ç§æåº¦è¶…å–ä¿¡å·åœ¨é©¬è‚¡è¿‘æœŸçš„ç›˜æ•´è¡Œæƒ…ä¸­ï¼Œå¾€å¾€å¯¹åº”ç€ 24-48 å°æ—¶å†…çš„ç©ºå¤´åŠ¨èƒ½å½»åº•è¡°ç«­ã€‚ä¸‹è¡Œé£é™©å·²è¢«é‡åŒ–é”å®šåœ¨ 1.5% å·¦å³çš„æå°ç©ºé—´å†…ï¼Œè€Œå‘ä¸Šçš„ä¼°å€¼ä¿®å¤ç©ºé—´é˜ˆå€¼å·²æ‰©å±•è‡³ 6.5% ä»¥ä¸Šã€‚å»ºè®®æ‰§è¡Œâ€œåˆ†æ‰¹å»ºä»“â€ç­–ç•¥ï¼Œåšå¼ˆçŸ­æœŸå‡çº¿ä¿®å¤åå¼¹ã€‚ğŸ±ğŸ’\n\n`;
                        content += `äºŒã€ä¸»åŠ›åšå¼ˆç‰¹å¾ï¼š\nä¸»åŠ›æŒä»“é‡å¿ƒæ­£åœ¨ç¨³æ­¥ä¸‹ç§»ã€‚æ¢æ‰‹ç‡åŸºå› åˆ†ææ˜¾ç¤ºï¼Œç›®å‰å¤„äºæœºæ„å¸ç­¹çš„æœ«ç«¯é˜¶æ®µï¼Œæ•£æˆ·ææ…Œæ€§ç›˜æ•´å·²è¾¾ä¸´ç•Œç‚¹ã€‚Money ç›‘æµ‹åˆ°åœ¨å…³é”®æ”¯æ’‘ä½é™„è¿‘æœ‰éšè”½çš„æ‰˜å•è¡Œä¸ºã€‚ç›®å‰å»ºè®®ä¿æŒè€å¿ƒã€‚ç»“è®ºï¼šæœˆçº¿çº§åˆ«åº•éƒ¨ç¡®è®¤ã€‚`;
                    } else if (rsi > 62) {
                        content += `æ£€æµ‹åˆ°å¸‚åœºæƒ…ç»ªå¤„äºä¸¥é‡è¿‡çƒ­çŠ¶æ€ã€‚å½“å‰è‚¡ä»·å·²å¤§å¹…åç¦» 30 æ—¥å­£åº¦ä¸­è½´ã€‚å†å²æ•°æ®è­¦ç¤ºï¼Œå½“æ ‡çš„è§¦åŠè¯¥æŠ›å”®è­¦æˆ’çº¿åï¼Œå¾€å¾€ä¼šä¼´éšå‰§çƒˆçš„ä¼°å€¼å›å½’ä¸å¤šå¤´å›åã€‚ç›®å‰çš„ä¸Šæ¶¨åŸºå› ç¼ºä¹åº•å±‚æ”¯æ’‘ï¼Œå±äºå…¸å‹çš„â€œé¡¶éƒ¨èƒŒç¦»â€å½¢æ€ï¼Œè·åˆ©ç›˜å›åå‹åŠ›å·¨å¤§ã€‚å»ºè®®ä¸¥æ ¼æ‰§è¡Œâ€œé˜²å¾¡æ”¶ç½‘â€ç­–ç•¥ï¼Œåˆ‡å‹¿ç›²ç›®åšå¼ˆé±¼å°¾è¡Œæƒ…ã€‚å‡†å¤‡å¥½è¿æ¥éšæ—¶å¯èƒ½çˆ†å‘çš„ 5% ä»¥ä¸Šçš„é«˜ä½è·³æ°´é£é™©ã€‚ğŸŸğŸ›‘\n\n`;
                        content += `äºŒã€ä¸»åŠ›åšå¼ˆç‰¹å¾ï¼š\nMoney å¼•æ“ç›‘æµ‹åˆ°å–ç›˜æŒ‚å•é‡å‘ˆå¯¹æ•°çº§å¢åŠ ã€‚ç›®å‰çš„ç­¹ç åˆ†å¸ƒæ˜¾ç¤ºï¼Œé«˜ä½å¥—ç‰¢ç›˜é£é™©æ­£åœ¨ç§¯èšã€‚ç»“è®ºï¼šå¤„äºé«˜ä½æ´¾å‘åŒºé—´ï¼Œå»ºè®®è½è¢‹ä¸ºå®‰ã€‚`;
                    } else {
                        content += `å½“å‰å¤„äºå…¸å‹çš„â€œä¸­è½´ç±»å¸ƒæœ—è¿åŠ¨â€ç›˜æ•´çŠ¶æ€ã€‚è‚¡ä»·å›´ç»•æœˆçº¿ä¸­æ¢è¿›è¡Œçª„å¹…éœ‡è¡ï¼Œæ³¢åŠ¨ç‡å¤„äºå¥åº·æ°´å¹³ã€‚æœªå‘ç°ä¸»åŠ›å¤§è§„æ¨¡å¼‚åŠ¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†é€šè¿‡æ—¶é—´æ¢ç©ºé—´æ¥æ¶ˆåŒ–ä¸Šæ–¹çš„å‡çº¿å‹åŠ›ã€‚æ¢æ‰‹ç‡ç»´æŒåœ¨åˆç†åŒºé—´ï¼Œä¸»åŠ›ä¸æ•£æˆ·çš„åšå¼ˆè¶‹äºå¹³è¡¡ã€‚å»ºè®®ä¿æŒè€å¿ƒï¼ŒæŒè‚¡è§‚å¯Ÿã€‚ğŸ±\n\n`;
                        content += `äºŒã€ä¸»åŠ›åšå¼ˆç‰¹å¾ï¼š\næ”¯æ’‘ä½ç²¾å‡†é”å®šåœ¨ RM ${(price * 0.982).toFixed(3)}ï¼Œé˜»åŠ›ä½é”å®šåœ¨ RM ${(price * 1.035).toFixed(3)}ã€‚ç»“è®ºï¼šè¶‹åŠ¿å¤„äºé€‰æ‹©æœŸï¼Œå»ºè®®é™é»˜è§‚å¯Ÿã€‚`;
                    }

                    lastReport = content;
                    adviceBox.innerText = content;
                    adviceBox.scrollTop = 0;
                    adviceBox.classList.add('bg-blue-500/20');
                    setTimeout(() => adviceBox.classList.remove('bg-blue-500/20'), 500);

                } catch (e) {
                    adviceBox.innerText = "åˆ†æå¼•æ“æš‚æ—¶ä¼‘çœ ... ğŸ±ğŸ’¤";
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    iconWrapper.innerHTML = '<i data-lucide="target" size="18"></i>'; 
                    btnText.innerText = "MMAåˆ†æç®€æŠ¥";
                    lucide.createIcons(); 
                }
            }, 4000); 
        };

        window.shareToWhatsApp = () => {
            const price = currentStock.price.toFixed(3);
            const content = lastReport || `${currentStock.name} ç›®å‰æŠ¥ RM ${price}ã€‚æ‰§è¡Œåˆ†æè·å–å®Œæ•´ç ”æŠ¥ã€‚`;
            const message = `*ğŸ“Š MMA æ·±åº¦é‡åŒ–ç ”æŠ¥*\n--------------------------------\n*è‚¡ç¥¨:* ${currentStock.name} (${currentStock.code}.KL)\n*ä»·æ ¼:* RM ${price}\n--------------------------------\n\n${content}\n\n_â€”â€” æ•°æ®ç”± Money & Max Analyst è”æ‰‹æ ¡å‡† ğŸ‘¨â€ğŸ’»ğŸ±_`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        };

        window.calibratePrice = () => {
            const val = parseFloat(document.getElementById('manualPriceInput').value);
            if (!isNaN(val) && val > 0) { currentStock.price = val; updateUI(); }
        };

        function updateSector(s) { activeSector = s; renderFilters(); renderStockList(); }

        function renderFilters() {
            const el = document.getElementById('sectorFilters');
            if(!el) return;
            el.innerHTML = SECTORS_LIST.map(s => `
                <button onclick="updateSector('${s}')" class="whitespace-nowrap px-3 py-1.5 rounded-lg text-[9px] font-black transition-all ${activeSector === s ? 'bg-slate-900 text-white' : 'bg-white text-slate-400 border border-slate-200'}">${s}</button>
            `).join('');
        }

        function renderStockList() {
            const stockList = document.getElementById('stockList');
            const searchInput = document.getElementById('searchInput');
            if(!stockList || !searchInput) return;
            const query = searchInput.value.toLowerCase().trim();
            let filtered = STOCKS.filter(s => s.name.toLowerCase().includes(query) || s.code.includes(query));
            if (activeSector !== 'å…¨éƒ¨') filtered = filtered.filter(s => activeSector === 'åˆ›ä¸šæ¿' ? (s.sector === 'åˆ›ä¸šæ¿' || s.code.startsWith('0')) : s.sector === activeSector);
            
            stockList.innerHTML = filtered.slice(0, 30).map(s => `
                <button onclick="selectStock('${s.code}')" class="stock-card flex items-center gap-2 p-1.5 pr-3 rounded-xl shrink-0 ${currentStock.code === s.code ? 'active-card' : 'bg-white/60'}">
                    <div class="w-1 h-6 rounded-full ${s.price >= s.initialPrice ? 'bg-emerald-500' : 'bg-rose-500'}"></div>
                    <div class="text-left leading-none">
                        <p class="text-[10px] font-extrabold text-slate-900">${s.name}</p>
                        <p class="text-[8px] text-slate-400 font-mono">${s.code}</p>
                    </div>
                </button>
            `).join('');
        }

        window.selectStock = (code) => {
            const found = STOCKS.find(s => s.code === code);
            if (found) { currentStock = found; document.getElementById('manualPriceInput').value = currentStock.price; updateUI(); renderStockList(); lucide.createIcons(); }
        };

        function updateUI() {
            const d = new Date().toISOString().split('T')[0];
            historyDataset = generateSmooth30DayHistory(currentStock, currentStock.price);
            const rsi = calculateRSI(historyDataset.map(d => d.price));
            
            setText('headerDate', d);
            setText('priceAsOfDate', d);
            setText('displayPrice', 'RM ' + currentStock.price.toFixed(3));
            
            const startP = historyDataset[0].price;
            const pct = ((currentStock.price - startP) / startP * 100).toFixed(2);
            setText('displayChange', `(${pct >= 0 ? '+' : ''}${pct}%)`);
            const cEl = document.getElementById('displayChange'); if(cEl) cEl.className = `text-[10px] font-bold ${pct >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;

            setText('displayRSI', rsi);
            const rBar = document.getElementById('rsiBar'); if(rBar) { rBar.style.width = rsi + '%'; rBar.className = `h-full transition-all duration-700 ${rsi < 35 ? 'bg-emerald-500' : (rsi > 65 ? 'bg-rose-500' : 'bg-blue-600')}`; }

            let st = 'è¶‹åŠ¿å¹³è¡¡'; let cl = 'text-blue-500';
            if (rsi < 38) { st = 'æœˆåº¦è¶…å–'; cl = 'text-emerald-600'; } else if (rsi > 62) { st = 'æœˆåº¦è¶…ä¹°'; cl = 'text-rose-600'; }

            setText('displayStatus', st);
            const sEl = document.getElementById('displayStatus'); if(sEl) sEl.className = `text-2xl font-black tracking-tighter ${cl} leading-none`;
            
            setText('displaySector', currentStock.sector);
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart')?.getContext('2d');
            if (!ctx) return;
            if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyDataset.map(d => d.date),
                    datasets: [{
                        data: historyDataset.map(d => d.price),
                        borderColor: '#2563eb', borderWidth: 3.5, fill: true,
                        backgroundColor: 'rgba(37, 99, 235, 0.05)', tension: 0.35, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { ticks: { maxTicksLimit: 4 }, grid: { display: false } }, 
                        y: { grid: { color: '#f1f5f9' }, ticks: { font: { weight: '800' }, color: '#94a3b8' } } 
                    }
                }
            });
        }

        document.getElementById('searchInput')?.addEventListener('input', renderStockList);
        window.onload = () => { renderFilters(); renderStockList(); updateUI(); };
    </script>
</body>
</html>
