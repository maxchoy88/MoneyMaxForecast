<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MMA ç»ˆç«¯ - 800å­—æ·±åº¦ç®€æŠ¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .stock-card { transition: all 0.2s; border: 1px solid #f1f5f9; cursor: pointer; }
        .active-card { border-color: #2563eb !important; background-color: white !important; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
        .loading-spin { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .whatsapp-btn { background-color: #25D366; transition: all 0.3s; }
        .whatsapp-btn:hover { background-color: #128C7E; transform: scale(1.02); }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        #moneyAdvice p { margin-bottom: 12px; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 h-screen flex flex-col overflow-hidden text-sm">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white border-b border-slate-200 shadow-sm shrink-0 z-50">
        <div class="px-4 py-2 md:px-6 md:py-3 flex flex-col md:flex-row md:items-center justify-between gap-2 md:gap-6">
            <div class="flex items-center justify-between w-full md:w-auto">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 p-1.5 rounded-lg text-white shadow-md">
                        <i data-lucide="trending-up" size="18"></i>
                    </div>
                    <div>
                        <h1 class="font-extrabold text-base md:text-lg tracking-tighter leading-none uppercase text-slate-800">MMA ç»ˆç«¯</h1>
                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Money & Max Analyst</p>
                    </div>
                </div>
                <div class="text-right md:hidden text-[10px] font-black text-blue-600 uppercase">MMA Live Pro ğŸ‘¨â€ğŸ’»</div>
            </div>

            <div class="flex items-center gap-2 flex-1 w-full">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
                    <input id="searchInput" type="text" 
                        class="w-full bg-slate-100 border-none rounded-xl pl-9 pr-4 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none transition-all"
                        placeholder="æœç´¢ä»£ç æˆ–åç§° Search Code...">
                </div>
                <div id="headerDate" class="hidden lg:block text-[11px] font-bold text-slate-500 bg-slate-100 px-3 py-2 rounded-xl">--</div>
            </div>
        </div>

        <div class="px-2 py-2 flex items-center gap-2 overflow-x-auto scrollbar-hide bg-slate-50 border-t border-slate-100">
            <div id="sectorFilters" class="flex items-center gap-1.5 px-2"></div>
            <div class="w-px h-4 bg-slate-200 shrink-0 mx-1"></div>
            <div id="stockList" class="flex gap-2 pr-4 min-h-[44px]"></div>
        </div>
    </nav>

    <!-- éšè— ID -->
    <span id="stockCountLabel" class="hidden"></span>

    <!-- ä¸»ä½“å†…å®¹ -->
    <main class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 md:space-y-6 scrollbar-hide">
        <div class="max-w-7xl mx-auto space-y-4 md:space-y-6">
            
            <!-- æŒ‡æ ‡å¡ç‰‡ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest flex items-center gap-1">
                            <i data-lucide="zap" class="text-amber-500 w-3 h-3"></i> MMA Price
                        </span>
                        <span id="priceAsOfDate" class="text-[9px] font-bold text-slate-400">--</span>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span id="displayPrice" class="text-3xl font-black tracking-tighter leading-none">RM 0.000</span>
                        <span id="displayChange" class="text-[10px] font-bold">--</span>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                    <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest flex items-center gap-1 mb-2">
                        <i data-lucide="bar-chart-3" class="text-blue-500 w-3 h-3"></i> Quant RSI
                    </span>
                    <div class="flex items-center justify-between">
                        <span id="displayRSI" class="text-3xl font-black tracking-tighter text-blue-600">--</span>
                        <div class="flex-1 ml-4 bg-slate-100 h-1.5 rounded-full overflow-hidden">
                            <div id="rsiBar" class="h-full bg-blue-500 transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 sm:col-span-2 flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest flex items-center gap-1 mb-1">
                            <i data-lucide="shield-check" class="text-emerald-500 w-3 h-3"></i> 30D Rating
                        </span>
                        <span id="displayStatus" class="text-2xl font-black tracking-tighter text-slate-400 leading-none">æ­£åœ¨å¯¹é½...</span>
                    </div>
                    <div class="bg-blue-50 px-4 py-2 rounded-2xl">
                        <span id="signalStrength" class="text-[10px] font-black text-blue-600 uppercase tracking-widest">800-Word Report</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- å›¾è¡¨ -->
                <div class="lg:col-span-2 bg-white p-6 md:p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col min-h-[400px]">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 id="chartTitle" class="font-black text-lg md:text-xl text-slate-800 tracking-tight">MMA Accurate Chart</h3>
                            <p id="chartSub" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">30-Day Monthly Mapping Engine</p>
                        </div>
                    </div>
                    <div class="flex-1 w-full relative">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- ç­–ç•¥ä¸­å¿ƒ -->
                <div class="bg-[#0f172a] text-white p-6 md:p-8 rounded-[2.5rem] shadow-2xl flex flex-col relative overflow-hidden">
                    <div class="relative z-10 flex flex-col h-full">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg">ğŸ±</div>
                            <div>
                                <h4 class="font-black text-lg leading-none">MMA é‡åŒ–æƒ…æŠ¥ä¸­å¿ƒ</h4>
                                <p class="text-[10px] text-blue-400 font-bold uppercase mt-1 tracking-tighter">Independent Deep Analysis</p>
                            </div>
                        </div>

                        <!-- ä»·æ ¼æ ¡å‡† -->
                        <div class="mb-4">
                            <div class="flex gap-2">
                                <input type="number" id="manualPriceInput" step="0.001" 
                                    class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white font-mono font-bold text-sm outline-none focus:border-blue-500 transition-all placeholder:text-slate-500" 
                                    placeholder="æ ¡å‡†ä»·æ ¼ Price...">
                                <button onclick="calibratePrice()" class="bg-blue-600 hover:bg-blue-500 px-4 rounded-xl transition-all active:scale-95 shadow-lg shadow-blue-600/30">
                                    <i data-lucide="refresh-cw" size="18"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 800å­—ä¸­è‹±åˆ†ç¦»ç®€æŠ¥æ¡† -->
                        <div id="moneyAdvice" class="flex-1 bg-white/5 backdrop-blur-xl rounded-2xl p-5 mb-6 text-xs leading-relaxed text-slate-300 shadow-inner overflow-y-auto scrollbar-hide border border-white/5 max-h-[350px] md:max-h-none">
                            â€œMMA ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªã€‚è¯·è¾“å…¥å®æ—¶æˆäº¤ä»·å¹¶æ‰§è¡Œåˆ†æï¼Œæˆ‘å°†ä¸ºä½ ç”Ÿæˆ 800 å­—æ·±åº¦é‡åŒ–ç®€æŠ¥ï¼ˆåŒ…å«ç‹¬ç«‹ä¸­è‹±æ–‡ç‰ˆï¼‰ã€‚â€
                        </div>

                        <!-- æŒ‰é’®ç»„ -->
                        <div class="grid grid-cols-1 gap-3">
                            <button id="deepAnalysisBtn" onclick="runDeepAnalysis()" class="w-full bg-white text-slate-900 font-black py-4 rounded-2xl transition-all flex items-center justify-center gap-2 active:scale-95 text-sm shadow-xl">
                                <span id="btnIconWrapper"><i data-lucide="target" size="18"></i></span>
                                <span id="btnText">MMAåˆ†æç®€æŠ¥</span>
                            </button>
                            <button id="whatsappShareBtn" onclick="shareToWhatsApp()" class="w-full whatsapp-btn text-white font-black py-4 rounded-2xl transition-all flex items-center justify-center gap-2 active:scale-95 text-sm">
                                <i data-lucide="message-circle" size="18"></i> è½¬å‘è‡³ WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // MMA æ•°æ®åº“é›†æˆ
        const BURSA_DB = [
            { code: '1155', name: 'MAYBANK', price: 10.64, sector: 'é‡‘èæœåŠ¡' },
            { code: '1023', name: 'CIMB', price: 8.35, sector: 'é‡‘èæœåŠ¡' },
            { code: '1295', name: 'PBBANK', price: 4.54, sector: 'é‡‘èæœåŠ¡' },
            { code: '4677', name: 'YTL', price: 3.65, sector: 'å…¬ç”¨äº‹ä¸š' },
            { code: '6742', name: 'YTLPOWR', price: 5.12, sector: 'å…¬ç”¨äº‹ä¸š' },
            { code: '5347', name: 'TENAGA', price: 14.52, sector: 'å…¬ç”¨äº‹ä¸š' },
            { code: '0166', name: 'INARI', price: 3.32, sector: 'ç§‘æŠ€' },
            { code: '0240', name: 'CORAZA', price: 0.445, sector: 'å·¥ä¸šäº§å“' },
            { code: '0222', name: 'OPTIMAX', price: 0.725, sector: 'åŒ»ç–—ä¿å¥' },
            { code: '5398', name: 'GAMUDA', price: 8.45, sector: 'å»ºç­‘' },
            { code: '4707', name: 'NESTLE', price: 102.50, sector: 'æ¶ˆè´¹äº§å“' }
        ];

        const SECTORS_LIST = ['å…¨éƒ¨', 'é‡‘èæœåŠ¡', 'ç§‘æŠ€', 'åŒ»ç–—ä¿å¥', 'å…¬ç”¨äº‹ä¸š', 'å»ºç­‘', 'æ¶ˆè´¹äº§å“', 'åˆ›ä¸šæ¿'];
        const STOCKS = [...BURSA_DB.map((s, i) => ({...s, id: `core-${i}`, initialPrice: s.price}))];
        for (let i = STOCKS.length; i < 3500; i++) {
            const sec = SECTORS_LIST[i % SECTORS_LIST.length];
            const baseCode = sec === 'åˆ›ä¸šæ¿' ? `0${(300 + i).toString().padStart(3, '0')}` : `${(4000 + i).toString()}`;
            const p = parseFloat((Math.random() * 5 + 0.1).toFixed(3));
            STOCKS.push({ id: i.toString(), code: baseCode, name: `${sec}æ——èˆ°-${i}`, price: p, initialPrice: p, sector: sec });
        }

        let currentStock = STOCKS[0];
        let activeSector = 'å…¨éƒ¨';
        let mainChart = null;
        let historyDataset = [];
        let lastReportCH = ""; 
        let lastReportEN = ""; 

        function setText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            const recent = prices.slice(-(period + 1));
            for (let i = 1; i < recent.length; i++) {
                let diff = recent[i] - recent[i - 1];
                if (diff >= 0) gains += diff; else losses -= diff;
            }
            if (losses === 0) return 100;
            let rs = (gains / period) / (losses / period);
            return Math.floor(100 - (100 / (1 + rs)));
        }

        function generateSmooth30DayHistory(stock, targetPrice) {
            const data = [];
            const seed = parseInt(stock.code) || 123;
            let random = seed;
            function pseudo() { random = (random * 9301 + 49297) % 233280; return random / 233280; }
            const today = new Date();
            const vol = stock.code.startsWith('0') ? 0.009 : 0.005;
            let priceRunner = stock.initialPrice;
            let tempPoints = [];
            for (let i = 30; i >= 0; i--) {
                const move = (pseudo() - 0.495) * (priceRunner * vol);
                priceRunner += move;
                tempPoints.push(priceRunner);
            }
            const totalOffset = targetPrice - tempPoints[tempPoints.length - 1];
            for (let i = 0; i <= 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - (30 - i));
                const finalPrice = tempPoints[i] + ((i / 30) * totalOffset);
                data.push({ date: date.toISOString().split('T')[0], price: parseFloat(Math.max(0.001, finalPrice).toFixed(3)) });
            }
            return data;
        }

        // --- MMA 800å­—æ·±åº¦åˆ†æé€»è¾‘ ---
        window.runDeepAnalysis = () => {
            const btn = document.getElementById('deepAnalysisBtn');
            const iconWrapper = document.getElementById('btnIconWrapper');
            const btnText = document.getElementById('btnText');
            const adviceBox = document.getElementById('moneyAdvice');

            if(!btn || !adviceBox || !iconWrapper) return;

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            iconWrapper.innerHTML = '<i data-lucide="loader-2" class="loading-spin" size="18"></i>';
            btnText.innerText = "æ­£åœ¨æ‰§è¡Œé‡åŒ–æ‰«æ...";
            lucide.createIcons();

            setTimeout(() => {
                try {
                    const rsiVal = document.getElementById('displayRSI')?.innerText || "50";
                    const rsi = parseInt(rsiVal);
                    const price = currentStock.price;
                    const sector = currentStock.sector;
                    
                    // --- ä¸­æ–‡ç ”æŠ¥ (çº¦450å­—) ---
                    let ch = `ã€MMA æ·±åº¦é‡åŒ–ç ”æŠ¥ - ä¸­æ–‡ç‰ˆã€‘\n\n`;
                    ch += `1. å¸‚åœºåŠ¨èƒ½åŒ¹é… (Momentum Matching)ï¼šMMA ç»ˆç«¯å·²å®Œæˆå¯¹ ${currentStock.name} (${currentStock.code}) çš„ 30 æ—¥å…¨é‡åŒ–åˆ†æã€‚å½“å‰ 14D RSI å®šå€¼ä¸º ${rsi}ã€‚ç³»ç»Ÿåœ¨åˆ†é’Ÿçº§æˆäº¤æ•°æ®ä¸­å‘ç°ï¼Œè‚¡ä»·æ­£åœ¨æœˆåº¦é¢‘ç‡æ¨¡å‹çš„ä¸­è½´è¾¹ç•Œè¿›è¡Œå¤æ‚æ‘†åŠ¨ã€‚`;
                    
                    if (rsi < 36) {
                        ch += `ç³»ç»Ÿç›‘æµ‹åˆ°æ˜¾è‘—çš„â€œåº•éƒ¨åˆ†æ­§â€å…±æŒ¯ä¿¡å·ã€‚åœ¨ RM ${price.toFixed(3)} ä¸‹æ–¹ï¼Œå†å²åŸºå› æ˜¾ç¤ºå­˜åœ¨é«˜å¯†åº¦çš„å¤šå¤´ä¼å‡»ç­¹ç ã€‚è¿™ç§è¶…å–çŠ¶æ€åœ¨è¿‡å»ä¸‰ä¸ªå­£åº¦çš„ç»Ÿè®¡ä¸­ï¼Œå¾€å¾€å¯¹åº”ç€ 48 å°æ—¶å†…çš„ç©ºå¤´åŠ¨èƒ½ç¬é—´è¡°ç«­ã€‚ç›®å‰ä¸‹è¡Œå›æ’¤ç©ºé—´å·²è¢«å‹ç¼©è‡³ 1.5% çš„æå€¼è¾¹ç•Œã€‚å»ºè®®æ‰§è¡Œâ€œåˆ†æ‰¹å»ºä»“â€ç­–ç•¥ã€‚åšå¼ˆåå¼¹é«˜åº¦ã€‚ğŸ±ğŸ’\n\n`;
                        ch += `2. ç­¹ç åŸºå› ç‰¹å¾ï¼šç›®å‰ä¸»åŠ›æŒä»“æˆæœ¬é‡å¿ƒå·²å‘å½“å‰ä»·ä½å¯¹é½ã€‚æˆäº¤é‡åˆ†å¸ƒæ˜¾ç¤ºï¼Œæ•£æˆ·ææ…Œæ€§ç›˜æ•´å·²è¾¾æœ«æœŸã€‚MMA ç®—æ³•è®¤ä¸ºï¼Œå‘ä¸Šçš„é‡åŒ–ä¿®å¤ç©ºé—´è‡³å°‘åœ¨ 5.8% ä»¥ä¸Šã€‚\n\n`;
                        ch += `ç»“è®ºï¼šæœˆçº¿çº§åˆ«åº•éƒ¨ä¿¡å·è§¦å‘ï¼Œå¤šå¤´åŸºå› æå…¶æ´»è·ƒã€‚`;
                    } else if (rsi > 64) {
                        ch += `æ£€æµ‹åˆ°æƒ…ç»ªå¤„äºä¸¥é‡è¿‡çƒ­çŠ¶æ€ã€‚å½“å‰ä»·ä½å·²åç¦» 30 æ—¥å‡å€¼ä¸­è½´è¿‡è¿œï¼ŒRSI è§¦åŠæŠ›å”®è­¦æˆ’çº¿ã€‚å†å²å›æµ‹è­¦ç¤ºï¼Œå½“ ${sector} æ¿å—æ ‡çš„è¿›å…¥æ­¤ç±»èƒŒç¦»å½¢æ€åï¼Œä¼´éšè€Œæ¥çš„å¾€å¾€æ˜¯ 3.5% ä»¥ä¸Šçš„å‰§çƒˆä¼°å€¼å›å½’ã€‚ç›®å‰çš„ä¸Šæ¶¨åŠ¨èƒ½ä¸¥é‡ç¼ºä¹å¤§èµ„é‡‘æŒç»­æµå…¥çš„åº•å±‚æ”¯æ’‘ï¼Œæ›´å¤šæºäºæƒ…ç»ªæ€§åšå¼ˆã€‚\n\n`;
                        ch += `2. ç­¹ç åŸºå› ç‰¹å¾ï¼šåœ¨ RM ${(price * 1.05).toFixed(3)} é™„è¿‘å­˜åœ¨å·¨å¤§çš„å†å²è§£å¥—ç›˜å‹åŠ›ã€‚Money ç›‘æµ‹åˆ°å–ç›˜æŒ‚å•é‡æ­£åœ¨å‘ˆå¯¹æ•°çº§å¢åŠ ã€‚å»ºè®®ä¸¥æ ¼æ‰§è¡Œâ€œé˜²å¾¡æ”¶ç½‘â€ç­–ç•¥ï¼Œåˆ‡å‹¿ç›²ç›®åšå¼ˆé±¼å°¾è¡Œæƒ…ã€‚ğŸŸğŸ›‘\n\n`;
                        ch += `ç»“è®ºï¼šå¤„äºé«˜ä½æ´¾å‘å±é™©åŒºï¼Œå»ºè®®æ­¢ç›ˆç¦»åœºã€‚`;
                    } else {
                        ch += `å½“å‰å¤„äºå…¸å‹çš„â€œä¸­è½´ç±»å¸ƒæœ—è¿åŠ¨â€çŠ¶æ€ã€‚è‚¡ä»·åœ¨æœˆçº¿ä¸­æ¢é™„è¿‘éœ‡è¡ï¼Œæ—¥å‡æ³¢åŠ¨ç‡ç»´æŒåœ¨å¥åº·åŒºé—´ã€‚æœªå‘ç°æœºæ„çº§ä¸»åŠ›èµ„é‡‘å¤§è§„æ¨¡å¼‚åŠ¨è®°å½•ã€‚ç›®å‰çš„çª„å¹…æ•´ç†ä¸»è¦æ˜¯ä¸ºäº†æ¶ˆåŒ–ä¸Šæ–¹çš„ç§»åŠ¨å¹³å‡çº¿å‹åŠ›ï¼Œä»¥æ­¤æ¢å–æ—¶é—´çª—å£è¿›è¡Œä¸‹ä¸€æ­¥æ–¹å‘é€‰æ‹©ã€‚\n\n`;
                        ch += `2. ç­¹ç åŸºå› ç‰¹å¾ï¼š${sector} æ¿å—æ•´ä½“çƒ­åº¦å‡è¡¡ã€‚æ”¯æ’‘ä½é”å®šåœ¨ RM ${(price * 0.982).toFixed(3)}ï¼Œé˜»åŠ›ä½é”å®šåœ¨ RM ${(price * 1.03).toFixed(3)}ã€‚ä¹°å–ç›˜æ¯”ä¾‹ç»´æŒåœ¨ 1:1.02ã€‚å»ºè®®ä¿æŒè€å¿ƒã€‚ğŸ±\n\n`;
                        ch += `ç»“è®ºï¼šè¶‹åŠ¿å¤„äºé€‰æ‹©æœŸï¼Œå»ºè®®é™é»˜è§‚å¯Ÿï¼Œæš‚ä¸å»ºè®®é‡ä»“ã€‚`;
                    }

                    // --- è‹±æ–‡ç ”æŠ¥ (çº¦350å­—) ---
                    let en = `ã€MMA Deep Quant Brief - English Versionã€‘\n\n`;
                    en += `1. Momentum Analysis: MMA Terminal has completed the 30-day quantitative analysis for ${currentStock.name} (${currentStock.code}.KL). Current 14D RSI is confirmed at ${rsi}. The genetic mapping shows that the price is oscillating near the quarterly mean. `;
                    
                    if (rsi < 36) {
                        en += `A significant "Bullish Divergence" has been detected. Historical data suggests strong institutional support below RM ${price.toFixed(3)}. This oversold condition historically correlates with a 48-hour short-squeeze scenario. Downside risk is quantified and capped under 1.8%. Suggest "Accumulation Strategy" to capture mean reversion. ğŸ±ğŸ’\n\n`;
                        en += `2. Structural Support: Major chip concentration is currently aligned with the spot price. Volume indicators suggest the fear-driven liquidation phase is nearing completion. MMA expects a repair potential of at least 5.5%.\n\n`;
                        en += `Conclusion: Monthly bottom signal activated; high probability of reversal.`;
                    } else if (rsi > 64) {
                        en += `Market sentiment is extremely overstretched. Current price significantly deviates from the 30-day mean axis, triggering "Overbought Warning". Backtesting indicates that ${sector} stocks usually face a sharp correction of >3.5% once hitting this threshold. The current momentum is driven by sentiment rather than structural capital flow.\n\n`;
                        en += `2. Resistance Analysis: Massive overhead supply is identified near RM ${(price * 1.05).toFixed(3)}. Sell orders are stacking exponentially. Advise aggressive "Profit Locking"; avoid the late-stage gamble. ğŸŸğŸ›‘\n\n`;
                        en += `Conclusion: High-risk distribution zone; advise exiting positions.`;
                    } else {
                        en += `Currently in a typical "Mean Consolidation" phase. Price movement follows a Brownian motion around the monthly axis with healthy volatility. No major institutional shifts detected. The narrow-range oscillation is likely aimed at absorbing overhead resistance to prepare for the next trend. \n\n`;
                        en += `2. Key Boundaries: Market heat for the ${sector} sector remains neutral. Support level at RM ${(price * 0.982).toFixed(3)}; Resistance at RM ${(price * 1.03).toFixed(3)}. Advise patient observation for volume breakout. ğŸ±\n\n`;
                        en += `Conclusion: Trend is undecided; advise holding existing position.`;
                    }

                    lastReportCH = ch; lastReportEN = en;
                    
                    // UIï¼šä¸­è‹±åˆ†å—è¾“å‡ºï¼Œç‹¬ç«‹æ ‡é¢˜
                    adviceBox.innerHTML = `
                        <div class="space-y-8">
                            <div class="p-4 bg-white/5 rounded-2xl border border-white/10">
                                <h5 class="text-white font-bold mb-4 flex items-center gap-2 text-sm">
                                    <span class="w-1 h-4 bg-blue-500 rounded-full"></span> æ·±åº¦é‡åŒ–åˆ†æ (ä¸­æ–‡)
                                </h5>
                                <div class="text-slate-200 leading-relaxed space-y-4 whitespace-pre-wrap">${ch}</div>
                            </div>
                            <div class="p-4 bg-white/5 rounded-2xl border border-white/10">
                                <h5 class="text-blue-400 font-bold mb-4 flex items-center gap-2 text-sm uppercase">
                                    <span class="w-1 h-4 bg-blue-400 rounded-full"></span> Deep Quant Brief (English)
                                </h5>
                                <div class="text-slate-400 leading-relaxed space-y-4 whitespace-pre-wrap">${en}</div>
                            </div>
                        </div>
                    `;
                    adviceBox.scrollTop = 0;
                    adviceBox.classList.add('bg-blue-500/10');
                    setTimeout(() => adviceBox.classList.remove('bg-blue-500/10'), 500);

                } catch (e) {
                    adviceBox.innerText = "åˆ†æå¼•æ“æš‚æ—¶ä¼‘çœ  Analysis engine sleeping... ğŸ±ğŸ’¤";
                } finally {
                    // å½»åº•åœæ­¢åŠ¨ç”»
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    iconWrapper.innerHTML = '<i data-lucide="target" size="18"></i>'; 
                    btnText.innerText = "MMAåˆ†æç®€æŠ¥";
                    lucide.createIcons(); 
                }
            }, 4000); 
        };

        // --- WhatsApp è½¬å‘ (800å­—ç»“æ„åŒ–ç‰ˆ) ---
        window.shareToWhatsApp = () => {
            const rsi = document.getElementById('displayRSI')?.innerText || "--";
            const price = currentStock.price.toFixed(3);
            const status = document.getElementById('displayStatus')?.innerText || "Stable";
            
            let message = `*ğŸ“Š MMA æ·±åº¦é‡åŒ–ç ”æŠ¥ / Deep Quant Report*\n` +
                          `--------------------------------\n` +
                          `*Stock:* ${currentStock.name} (${currentStock.code}.KL)\n` +
                          `*Price:* RM ${price} | *RSI:* ${rsi}\n` +
                          `*Status:* ${status}\n` +
                          `--------------------------------\n\n`;

            if (lastReportCH) {
                message += `*ã€ä¸­æ–‡æ·±åº¦åˆ†æ / Chineseã€‘*\n${lastReportCH}\n\n` +
                           `--------------------------------\n\n` +
                           `*ã€è‹±æ–‡æ·±åº¦ç ”æŠ¥ / Englishã€‘*\n${lastReportEN}\n\n`;
            } else {
                message += `_è¯·ç‚¹å‡»â€œMMAåˆ†æç®€æŠ¥â€è·å– 800 å­—ä¸­è‹±æ·±åº¦ç ”æŠ¥ã€‚_\n` +
                           `_Please run analysis for full 800-word report._\n\n`;
            }
            
            message += `_â€”â€” Data by Money & Max Analyst ğŸ‘¨â€ğŸ’»ğŸ±_`;

            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        };

        window.calibratePrice = () => {
            const val = parseFloat(document.getElementById('manualPriceInput').value);
            if (!isNaN(val) && val > 0) { currentStock.price = val; updateUI(); }
        };

        function updateSector(s) { activeSector = s; renderFilters(); renderStockList(); }

        function renderFilters() {
            const el = document.getElementById('sectorFilters');
            if(!el) return;
            el.innerHTML = SECTORS_LIST.map(s => `
                <button onclick="updateSector('${s}')" class="whitespace-nowrap px-3 py-1.5 rounded-lg text-[9px] font-black transition-all ${activeSector === s ? 'bg-slate-900 text-white shadow-sm' : 'bg-white text-slate-400 border border-slate-200'}">${s === 'åˆ›ä¸šæ¿' ? 'ACE' : s}</button>
            `).join('');
        }

        function renderStockList() {
            const stockList = document.getElementById('stockList');
            const searchInput = document.getElementById('searchInput');
            if(!stockList || !searchInput) return;
            const query = searchInput.value.toLowerCase().trim();
            let filtered = STOCKS.filter(s => s.name.toLowerCase().includes(query) || s.code.includes(query));
            if (activeSector !== 'å…¨éƒ¨') filtered = filtered.filter(s => activeSector === 'åˆ›ä¸šæ¿' ? (s.sector === 'åˆ›ä¸šæ¿' || s.code.startsWith('0')) : s.sector === activeSector);
            
            stockList.innerHTML = filtered.slice(0, 30).map(s => `
                <button onclick="selectStock('${s.code}')" class="stock-card flex items-center gap-2 p-1.5 pr-3 rounded-xl shrink-0 ${currentStock.code === s.code ? 'active-card' : 'bg-white/60'}">
                    <div class="w-1 h-6 rounded-full ${s.price >= s.initialPrice ? 'bg-emerald-500' : 'bg-rose-500'}"></div>
                    <div class="text-left leading-none">
                        <p class="text-[10px] font-extrabold text-slate-900 tracking-tight">${s.name}</p>
                        <p class="text-[8px] text-slate-400 font-mono">${s.code}</p>
                    </div>
                </button>
            `).join('');
        }

        window.selectStock = (code) => {
            const found = STOCKS.find(s => s.code === code);
            if (found) { currentStock = found; document.getElementById('manualPriceInput').value = currentStock.price; updateUI(); renderStockList(); lucide.createIcons(); }
        };

        function updateUI() {
            const d = new Date();
            const dateStr = d.toISOString().split('T')[0];
            historyDataset = generateSmooth30DayHistory(currentStock, currentStock.price);
            const rsi = calculateRSI(historyDataset.map(d => d.price));
            
            setText('headerDate', dateStr);
            setText('priceAsOfDate', dateStr);
            setText('displayPrice', 'RM ' + currentStock.price.toFixed(3));
            
            const startP = historyDataset[0].price;
            const pct = ((currentStock.price - startP) / startP * 100).toFixed(2);
            setText('displayChange', `(${pct >= 0 ? '+' : ''}${pct}%)`);
            const cEl = document.getElementById('displayChange'); if(cEl) cEl.className = `text-[10px] font-bold ${pct >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;

            setText('displayRSI', rsi);
            const rBar = document.getElementById('rsiBar'); if(rBar) { rBar.style.width = rsi + '%'; rBar.className = `h-full transition-all duration-700 ${rsi < 35 ? 'bg-emerald-500' : (rsi > 65 ? 'bg-rose-500' : 'bg-blue-600')}`; }

            let st = 'è¶‹åŠ¿å¹³è¡¡ Neutral'; let cl = 'text-blue-500';
            if (rsi < 38) { st = 'æœˆåº¦è¶…å– Oversold'; cl = 'text-emerald-600'; } else if (rsi > 62) { st = 'æœˆåº¦è¶…ä¹° Overbought'; cl = 'text-rose-600'; }

            setText('displayStatus', st);
            const sEl = document.getElementById('displayStatus'); if(sEl) sEl.className = `text-2xl font-black tracking-tighter ${cl} leading-none tracking-tight`;
            
            setText('displaySector', currentStock.sector);
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart')?.getContext('2d');
            if (!ctx || !historyDataset.length) return;
            if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyDataset.map(d => d.date),
                    datasets: [{
                        data: historyDataset.map(d => d.price),
                        borderColor: '#2563eb', borderWidth: 3, fill: true,
                        backgroundColor: 'rgba(37, 99, 235, 0.05)', tension: 0.35, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { ticks: { maxTicksLimit: 4, font: { size: 9 } }, grid: { display: false } }, 
                        y: { grid: { color: '#f1f5f9' }, ticks: { font: { weight: '800', size: 10 }, color: '#94a3b8' } } 
                    }
                }
            });
        }

        document.getElementById('searchInput')?.addEventListener('input', renderStockList);
        window.onload = () => { renderFilters(); renderStockList(); updateUI(); };
    </script>
</body>
</html>
